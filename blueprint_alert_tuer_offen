blueprint:
  name: T√ºr Alarm mit Kamera Snapshot + Critical Push + Hue Rot
  description: >
    Sendet eine Critical Push-Nachricht mit Kamera Snapshot, wenn eine T√ºr ge√∂ffnet wird.
    Optional k√∂nnen mehrere Hue-Lampen auf rot geschaltet werden.
    Aktivierbar per input_boolean.
  domain: automation

  input:
    door_sensor:
      name: T√ºrsensor
      selector:
        entity:
          domain: binary_sensor
          device_class: door

    camera_entity:
      name: Kamera
      selector:
        entity:
          domain: camera

    notify_device:
      name: iPhone Ger√§t
      selector:
        device:
          integration: mobile_app

    enable_toggle:
      name: Alarm Ein/Aus Schalter
      selector:
        entity:
          domain: input_boolean

    hue_lights:
      name: Hue Lampen (optional)
      description: Lampen, die auf Rot gestellt werden sollen
      default: {}
      selector:
        target:
          entity:
            domain: light
            integration: hue

trigger:
  - platform: state
    entity_id: !input door_sensor
    from: "off"
    to: "on"

condition:
  - condition: state
    entity_id: !input enable_toggle
    state: "on"

variables:
  timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
  snapshot_file: "/config/www/tuer_snapshot_{{ timestamp }}.jpg"
  hue_targets: !input hue_lights

action:
  # Snapshot erstellen
  - service: camera.snapshot
    target:
      entity_id: !input camera_entity
    data:
      filename: "{{ snapshot_file }}"

  - delay: "00:00:03"

  # Hue Lampen optional schalten (ohne Template Condition!)
  - if:
      - condition: template
        value_template: "{{ hue_targets is defined and hue_targets.entity_id is defined }}"
    then:
      - service: light.turn_on
        target: !input hue_lights
        data:
          rgb_color: [255, 0, 0]
          brightness: 255

  # Critical Push
  - device_id: !input notify_device
    domain: mobile_app
    type: notify
    title: "üö® T√úR ALARM!"
    message: "Die T√ºr wurde ge√∂ffnet!"
    data:
      image: "/local/tuer_snapshot_{{ timestamp }}.jpg"
      push:
        sound:
          name: default
          critical: 1
          volume: 1.0

mode: single